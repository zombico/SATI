<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <title>Chatbot Debugger</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/favicon.png">
</head>

<body>
    <!-- Skip to main content link -->
    <a href="#userInput" class="skip-link">Skip to chat input</a>

    <!-- Left Side: Chat -->
    <main class="chat-container">
        <header class="chat-header">
            <h1 id="header-title" aria-live="polite">Loading</h1>
        </header>
        <div class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions" aria-atomic="false"></div>
        <form class="input-container" aria-label="Message input form">
            <div class="input-wrapper">
                <label for="userInput" class="visually-hidden">Chat message</label>
                <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off" aria-label="Type your message" required />
                <button type="submit" id="sendBtn" aria-label="Send message">Send</button>
            </div>
        </form>
    </main>

    <!-- Right Side: Logs -->
    <aside class="logs-container" aria-label="System Logs">
        <header class="logs-header">
            <h2>System Logs</h2>
        </header>
        <div class="logs-content" id="logs" role="log" aria-live="polite" aria-atomic="false">
            <div class="log-entry">
                <div class="log-timestamp">System initialized</div>
                <div class="log-data">For internal use only
                    <br>NOT: Legal advice
                </div>
            </div>
        </div>
    </aside>

    <script>
        const API_URL = 'http://localhost:3000';

        let turn = 1;
        let machineState = {};
        let conversationId = null;

        const messagesDiv = document.getElementById('messages');
        const headerTitleDiv = document.getElementById('header-title');
        const logsDiv = document.getElementById('logs');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        let botDisplayName = '';

        // Add message to chat
        function addMessage(content, isBot = false, thinking = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isBot ? 'bot' : 'user'}`;
            messageDiv.setAttribute('role', 'article');
            messageDiv.setAttribute('aria-label', isBot ? 'Bot message' : 'User message');

            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = isBot ? botDisplayName : null;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            if (thinking) {
                contentDiv.id = 'thinking-div';
                contentDiv.setAttribute('aria-label', 'Bot is thinking');
            }
            contentDiv.textContent = content;

            messageDiv.appendChild(label);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            // Auto scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Add log entry
        function addLog(type, data, conversationId) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = 'log-entry';

            const typeSpan = document.createElement('span');
            typeSpan.className = `log-type ${type}`;
            typeSpan.textContent = type;

            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'log-timestamp';
            timestampDiv.textContent = timestamp;
            timestampDiv.prepend(typeSpan);

            const dataDiv = document.createElement('div');
            dataDiv.className = 'log-data';
            dataDiv.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;

            logDiv.appendChild(timestampDiv);
            logDiv.appendChild(dataDiv);

            if (type === 'hash') {
                const conversationIdDiv = document.createElement('div');
                conversationIdDiv.className = 'log-data'
                conversationIdDiv.textContent = `Conversation Id: ${conversationId}`
                logDiv.appendChild(conversationIdDiv)
                const verifyButton = document.createElement('a');
                verifyButton.className = 'log-type verify'
                verifyButton.textContent = 'Verify hash';
                verifyButton.href = `/verify/${conversationId}`
                verifyButton.target = "_blank"
                logDiv.appendChild(verifyButton);
            }

            logsDiv.insertBefore(logDiv, logsDiv.firstChild);
        }

        // Send message to server
        async function sendMessage(event) {
            if (event) {
                event.preventDefault(); // Prevent form submission
            }

            const prompt = userInput.value.trim();
            if (!prompt) return;

            // Disable input while processing
            sendBtn.disabled = true;
            userInput.disabled = true;
            sendBtn.setAttribute('aria-busy', 'true');
            userInput.setAttribute('aria-busy', 'true');

            // Add user message to chat
            addMessage(prompt, false);

            // Log request
            addLog('request', { prompt, turn });

            // Clear input
            userInput.value = '';

            // Show thinking
            addMessage(" ", isBot = true, thinking = true)

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt, turn, conversationId })

                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                conversationId = data?.conversationId;
                // Log response
                await addLog('response', data.response, conversationId);
                await addLog('trace', data.trace, conversationId)
                await addLog('hash', data.hashMsg, conversationId)
                // Update machine state
                if (data.response.turn !== undefined) {
                    turn = data.response.turn + 1;
                    machineState = data.response;  // Keep the entire response object
                    machineState.turn = turn;  // Update turn for next iteration
                }
                // Remove thinking div
                messagesDiv.removeChild(messagesDiv.lastChild)
                // Add bot response to chat
                if (data.response.answer) {
                    const parsedResponse = DOMPurify.sanitize(marked.parse(data.response.answer));
                    addMessage('', true);
                    messagesDiv.lastChild.insertAdjacentHTML('beforeend',parsedResponse);
                } else if (typeof data.response === 'string') {
                    addMessage(data.response, true);
                } else {
                    addMessage(JSON.stringify(data.response), true);
                }

            } catch (error) {
                // Remove thinking div
                messagesDiv.removeChild(messagesDiv.lastChild)
                console.error('Error:', error);
                addLog('error', error.message);
                addMessage('Error: Failed to get response from server', true);
                // Add alert role to error message
                const errorDiv = messagesDiv.lastChild;
                errorDiv.setAttribute('role', 'alert');
            } finally {
                // Re-enable input
                sendBtn.disabled = false;
                userInput.disabled = false;
                sendBtn.removeAttribute('aria-busy');
                userInput.removeAttribute('aria-busy');
                userInput.focus();
            }
        }

        async function getContext() {
            try {
                fetch('/context')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Config:', data);
                        headerTitleDiv.textContent = data.name;
                        document.title = data.name;
                        botDisplayName=data.chatDisplayName;
                        sendBtn.textContent = data.buttonText;
                        userInput.placeholder = data.placeholder;
                        addMessage(data.firstMessage, isBot = true);
                    })
            } catch (e) {
                console.error(e)
            }
        }

        // Event listeners
        const inputForm = document.querySelector('.input-container');
        inputForm.addEventListener('submit', sendMessage);

        getContext();
        // Focus input on load
        userInput.focus();
    </script>
</body>

</html>